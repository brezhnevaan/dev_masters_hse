# Link Shortener Service

Сервис для создания и управления короткими ссылками с поддержкой авторизации, кэширования и фоновых задач.   
Базовый функционал — создание короткой ссылки (с указанием кастомного алиаса / срока жизни ссылки) и редирект на исходный url по короткой ссылке, доступны всем пользователям.   
Дополнительный функционал — статистика и управление ссылками, только зарегистрированным и авторизованным.

## Особенности реализации

1. Безопасность:
   - JWT аутентификация
   - Проверка прав доступа к ссылкам

2. Кэширование:
   - Используется Redis для кэширования активных ссылок
   - Кэш обновляется при каждом переходе по ссылке
   - Время жизни кэша - 1 час

3. Фоновые задачи:
   - Автоматическая проверка истекших ссылок
   - Перемещение истекших ссылок авторизованных пользователей в таблицу expired_link (очищает основную таблицу, открывает возможность переиспользовать алиасы истекших ссылок; истекшие ссылки не авторизованных юзеров удаляет)
   - Запуск каждые 10 минут

4. Хранилище: 
   - PostgreSQL для хранения информации о юзерах и ссылках
   - Alembic для поддержки миграций

5. Логирование:
   - Ротация логов по размеру и дате
   - Логирование всех операций с ссылками
   - Отдельные логи для разных компонентов системы 

## Описание API

### Аутентификация

#### Регистрация
```http
POST /auth/register

Request:
{
    "email": "user@example.com",
    "password": "password123",
     "is_active": true,         
    "is_superuser": false,      
    "is_verified": false        
}

Response:
{
    "id": "uuid",
    "email": "user@example.com",
    "is_active": true,
    "is_superuser": false,
    "is_verified": false
}
```
Поля is_active, is_superuser, is_verified — необязательные автозаполняемые.

#### Авторизация
```http
POST /auth/jwt/login

Request: username=user@example.com&password=password123

Response:
{
    "access_token": "jwt_token",
    "token_type": "bearer"
}
```

### Ссылки

#### Создание короткой ссылки

Доступно всем пользователям.

```http
POST /links/shorten

Request:
{
    "original_url": "https://example.com",
    "custom_alias": "string",
    "expires_at": "2025-12-31 23:59"        
}

Response:
{
  "message": "Ссылка успешно создана",
  "original_url": "https://example.com",
  "short_code": "string",                   
  "expires_at": "2025-12-31 23:59"
}
```
Поля custom_alias и expires_at являются необязательными. Если они не указаны, alias будет сгенерирован автоматически, срок жизни рассчитан как +14 дней от текущей даты и будет продлеваться на +14 дней при каждом переходе.

#### Поиск ссылки по оригинальному URL

Доступно авторизованным пользователям (ссылка должна быть создана авторизованным юзером).   
Выдает список всех алиасов заданного url, принадлежащих пользователю.

```http
GET /links/search?original_url=https://example.com


Response:
{ 
  "links": [
    {
      "original_url": "https://example.com",
      "short_code": "string"
    }
  ]
}
```

#### Удаление ссылки

Доступно авторизованным пользователям (ссылка должна быть создана авторизованным юзером).

```http
DELETE /links/{short_code}

Response: 
{
  "message": "Ссылка удалена"
}
```

#### Переход по короткой ссылке

Доступно всем пользователям.

```http
GET /links/{short_code}

Response: 307 Temporary Redirect to original_url
```

#### Обновление алиаса

Доступно авторизованным пользователям (ссылка должна быть создана авторизованным юзером).   
Позволяет по существующему алиасу заменить алиас для этого же url на другой.

```http
PUT /links/

Request:
{
    "short_code": "old-code",
    "new_short_code": "new-code" 
}

Response:
{
  "message": "Алиас успешно обновлён",
  "original_url": "https://example.com",
  "short_code": "new-code"
}
```
Поле new_short_code является необязательным. Если не указано — генерируется уникальный alias.

#### Получение статистики

Доступно авторизованным пользователям (ссылка должна быть создана авторизованным юзером).

```http
GET /links/{short_code}/stats

Response:
{
  "original_url": "https://example.com",
  "short_code": "string",
  "created_at": "2025-04-01 16:41:19.352130",
  "last_click_at": "2025-04-01 16:41:19.352130",
  "clicks": 0
}

```

#### Получение всех активных ссылок пользователя

Доступно авторизованным пользователям (ссылка должна быть создана авторизованным юзером).   
Выводит список всех активных ссылок и их шорткодов (включая статистику по ним), созданных юзером.

```http
GET /links/my_links

Response:
{
  "links": [
    {
      "short_code": "string",
      "original_url": "https://example.com",
      "created_at": "2025-04-01T16:45:52.191Z",
      "expires_at": "2025-04-01T16:45:52.191Z",
      "clicks": 0,
      "last_click_at": "2025-04-01T16:45:52.191Z"
    }
  ]
}
```

#### Скачивание всех активных ссылок пользователя

Доступно авторизованным пользователям (ссылка должна быть создана авторизованным юзером).   
Формирает csv-файл для скачивания всех активных ссылок и их шорткодов (включая статистику по ним), созданных юзером.

```http
GET /links/my_links/download

Response: CSV file
```
Структура csv-файла: Short Code, Original URL, Created At, Expires At, Clicks, Last Click At.

#### Получение всех истекших ссылок пользователя

Доступно авторизованным пользователям (ссылка должна быть создана авторизованным юзером).   
Выводит список всех истекших ссылок и их шорткодов (включая статистику по ним), созданных юзером.    
Включает id записи ссылки в базе, является уникальным идентификатором, по которому можно реактивировать истекшую ссылку (следующий метод).

```http
GET /links/expired

Response:
{
  "links": [
    {
      "id": 0,
      "original_url": "https://example.com",
      "short_code": "string",
      "created_at": "2025-04-01T16:49:29.586Z",
      "expires_at": "2025-04-01T16:49:29.586Z",
      "last_click_at": "2025-04-01T16:49:29.586Z",
      "clicks": 0
    }
  ]
}
```

#### Скачивание всех истекших ссылок пользователя

Доступно авторизованным пользователям (ссылка должна быть создана авторизованным юзером).   
Формирает csv-файл для скачивания всех истекших ссылок и их шорткодов (включая статистику по ним), созданных юзером.

```http
GET /links/expired/download

Response: CSV file

```
Структура csv-файла: id, Short Code, Original URL, Created At, Expires At, Clicks, Last Click At

#### Реактивация истекшей ссылки

Доступно авторизованным пользователям (ссылка должна быть создана авторизованным юзером).   
Позволяет:
- реактивировать истекшую ссылку с тем же / обновленным алиасом или со сгенерированным уникальным кодом (в зависимости от того, является ли старый алиас уникальным для таблицы активных ссылок);
- задать или обновить срок жизни при реактивации; 
- сохраняет статистику старой ссылки.

```http
PUT /links/expired/reactivate

Request:
{
  "id": 0,
  "new_custom_alias": "string",
  "new_expires_at": "2025-04-01T16:54:09.073Z"
}

Response:
{
  "message": "Ссылка успешно реактивирована",
  "original_url": "https://example.com",
  "short_code": "string",
  "expires_at": "2025-04-01T16:54:09.073Z"
}
```
Поля new_custom_alias и new_expires_at — необязательные. Если new_custom_alias не задан —  проверяется уникальность текущего алиаса, если не занят — оставляет старый, если занят — гененирует автоматический уникальный код. Если new_expires_at не задан — создаем новый срок жизни по правилу + 14 дней к моменту активации.

## Инструкция по запуску

Сервис билдится через docker compose.

### Запуск через Docker

1. Соберите и запустите контейнеры:
```bash
docker-compose up --build
```
Приложение будет доступно по адресу: http://localhost:8001

### Доступ к swagger развернутого проекта на сервере

http://173.212.247.122:8001/docs

## Структура базы данных

### Таблица user

Хранит зарегистрированных пользователей.

- id (UUID, PK) - уникальный идентификатор пользователя
- email (VARCHAR) - email пользователя
- hashed_password (VARCHAR) - хеш пароля
- is_active (BOOLEAN) - статус активности
- is_superuser (BOOLEAN) - статус администратора
- is_verified (BOOLEAN) - статус верификации

### Таблица link

Хранит атрибуты активных ссылок, их статистику и связку user_id - владелец ссылки - id из таблицы user.

- id (INTEGER, PK) - уникальный идентификатор ссылки
- user_id (UUID, FK) - ID пользователя владельца ссылки (null для неавторизованных)
- original_url (TEXT) - оригинальный URL
- short_code (VARCHAR) - короткий код
- created_at (TIMESTAMP) - дата создания
- expires_at (TIMESTAMP) - дата истечения
- last_click_at (TIMESTAMP) - дата последнего перехода
- clicks (INTEGER) - количество переходов
- is_soft_expire (BOOLEAN) - тип истечения (мягкое/жесткое, устанавливается в зависимости от того, прописал ли юзер дату сам (жесткое), или настраиваем ли это поле мы по правилу + 14 дней от даты создания / последнего клика)

### Таблица expired_link

Хранит атрибуты истекших ссылок, их статистику и связку user_id - владелец ссылки - id из таблицы user.
В таблицу перемещаем только истекшие ссылки авторизованных пользователей, т.к. для неавторизованныз (user_id в таблице link is null) управление истекшими ссылками не доступно.

- id (INTEGER, PK) - уникальный идентификатор
- user_id (UUID, FK) - ID пользователя
- original_url (TEXT) - оригинальный URL
- short_code (VARCHAR) - короткий код
- created_at (TIMESTAMP) - дата создания
- expires_at (TIMESTAMP) - дата истечения
- last_click_at (TIMESTAMP) - дата последнего перехода
- clicks (INTEGER) - количество переходов
- is_soft_expire (BOOLEAN) - тип истечения
